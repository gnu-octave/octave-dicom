MKOCTFILE ?= mkoctfile -Wall
OCTAVE_CONFIG := @OCTAVE_CONFIG@
GREP      ?= @GREP@

ARCHDIR   := "$(shell $(OCTAVE_CONFIG) -p CANONICAL_HOST_TYPE)-$(shell $(OCTAVE_CONFIG) -p API_VERSION)"

GDCM_CPPFLAGS = @GDCM_CXXFLAGS@ @DEFS@
GDCM_LIBS = @GDCM_LIBS@

need_dict = dicominfo.oct dicomwrite.oct dicomlookup.oct dicomdisp.oct dicomanon.oct __dicom_stat__.oct

test_files = dicominfo.cpp dicomdict.cpp dicomread.cpp dicomlookup.cpp isdicom.cpp dicomuid.cpp dicomdisp.cpp dicomanon.cpp dicomwrite.cpp __dicom_decodeuid__.cpp

all: $(need_dict) dicomdict.oct dicomread.oct _gendicomdict.oct isdicom.oct dicomuid.oct __dicom_decodeuid__.oct archtests

%.o: %.cpp
	$(MKOCTFILE) $(GDCM_CPPFLAGS) -c $<

$(need_dict): %.oct: %.cpp dicomdict.o
	$(MKOCTFILE) $(GDCM_CPPFLAGS) $(GDCM_LIBS) $^

%.oct: %.cpp
	$(MKOCTFILE) $(OCTAVE_DEFS) $(GDCM_CPPFLAGS) $(GDCM_LIBS) $<

CPP_TST_SOURCES := $(shell $(GREP) --files-with-matches '^%!' $(test_files))
TST_SOURCES := $(patsubst %.cpp,../inst/$(ARCHDIR)/%.cpp-tst,$(CPP_TST_SOURCES))

.PHONY: archtests
archtests: $(TST_SOURCES)

../inst/$(ARCHDIR):
	@mkdir -p "$@"

../inst/$(ARCHDIR)/%.cpp-tst: %.cpp | ../inst/$(ARCHDIR)
	@echo "Extracting tests from $< ..."
	@$(RM) -f "$@" "$@-t"
	@(      echo "## Generated from $<"; \
	        $(GREP) '^%!' "$<") > "$@"

clean:
	$(RM) *.o *.oct *~
	test -e ../inst/$(ARCHDIR) && rm -f $(TST_SOURCES) || true
	test -e ../inst/$(ARCHDIR) && rmdir ../inst/$(ARCHDIR) || true

distclean: clean
	$(RM) config.log config.status config.h
	$(RM) -rf autom4te.cache
	$(RM) -r CMakeFiles
	$(RM) -f oct-alt-includes.h
	$(RM) Makefile
